<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<dom-module id="genesis-popover">

    <template>

        <style>
            /* shadow DOM styles go here */

            :host {
                --genesis-popover-max-width: 300px;
                --genesis-popover-min-height: 10px;
                --genesis-popover-margin: 15px;
                --genesis-popover-z-index: 10000;
            }

            .popper {
                background: var(--lumo-base-color) linear-gradient(var(--lumo-contrast-5pct), var(--lumo-contrast-5pct));
                border-radius: var(--lumo-border-radius);
                box-shadow: 0 0 0 1px var(--lumo-contrast-10pct), var(--lumo-box-shadow-l);
                font-family: var(--lumo-font-family);
                font-size: var(--lumo-font-size-m);
                font-weight: 400;
                line-height: var(--lumo-line-height-s);
                letter-spacing: 0;
                text-transform: none;
                -webkit-text-size-adjust: 100%;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;

                padding: var(--lumo-space-wide-l);
                max-width: var(--genesis-popover-max-width);
                min-height: var(--genesis-popover-min-height);
                z-index: var(--genesis-popover-z-index);
            }

            .popper[x-placement^="bottom"] {
                margin-top: var(--genesis-popover-margin);
            }

            .popper[x-placement^="top"] {
                margin-bottom: var(--genesis-popover-margin);
            }

            .popper[x-placement^="right"] {
                margin-left: var(--genesis-popover-margin);
            }

            .popper[x-placement^="left"] {
                margin-right: var(--genesis-popover-margin);
            }

            .popper-visible {
                display: flex;
            }

            .popper-hidden {
                display: none;
            }

        </style>

        <!-- shadow DOM goes here -->
        <span id="popoverEmitter" on-click="onClickEmitter">
         <slot></slot>
       </span>

        <div id="popoverContent" class$="[[popperClass]]">
            <slot name="content"></slot>
        </div>

    </template>

    <script>
        class GenesisPopover extends Polymer.Element {
            static get is() {
                return 'genesis-popover';
            }

            static get properties() {
                return {
                    visible: {
                        type: Boolean,
                        reflectToAttribute: true,
                        value: false,
                        notify: true,
                        observer: '_visibleChanged'
                    },
                    placement: {
                        type: String,
                        value: 'bottom',
                        reflectToAttribute: true
                    },
                    popperClass: {
                        type: String,
                        value: 'popper popper-hidden',
                    },
                    manualVisibility: {
                        type: Boolean,
                        reflectToAttribute: true,
                        value: false,
                    }
                }
            }

            ready() {
                super.ready();
                this.popperInstance = new Popper(
                    this.$.popoverEmitter,
                    this.$.popoverContent,
                    {
                        placement: this.placement,
                        modifiers: {
                            preventOverflow: {
                                boundariesElement: 'viewport',
                            },
                        },
                    }
                );
                if (this.visible) {
                    this.show();
                }
            }

            _visibleChanged(newValue, oldValue) {
                if (newValue && this.popperInstance != null) {
                    this.show();
                } else {
                    this.hide();
                }
            }

            constructor() {
                super();
                this._onClickOutside = this._onClickOutside.bind(this);
                this._onEscape = this._onEscape.bind(this);
            }

            _isOutside(x, y, rect) {
                return x < rect.left
                    || x > rect.right
                    || y < rect.top
                    || y > rect.bottom;
            };

            _onClickOutside(event) {
                var contentRect = this.$.popoverContent.getBoundingClientRect();
                var emitterRect = this.$.popoverEmitter.getBoundingClientRect();
                if (this._isOutside(event.clientX, event.clientY, contentRect)
                    && this._isOutside(event.clientX, event.clientY, emitterRect)) {
                    this.hide();
                }
            };

            _onEscape(event) {
                if (event.key === 'Escape') {
                    this.hide();
                }
            }

            onClickEmitter() {
                if (this.manualVisibility) {
                    return;
                }
                if (this.visible) {
                    this.hide();
                } else {
                    this.show();
                }
            }

            show() {
                this.popperInstance.scheduleUpdate();
                this.popperClass = "popper popper-visible";
                this.visible = true;

                document.addEventListener("click", this._onClickOutside, true);
                document.addEventListener("keydown", this._onEscape, true);
            }

            hide() {
                document.removeEventListener("click", this._onClickOutside, true);
                document.removeEventListener("keydown", this._onEscape, true);

                this.popperClass = "popper popper-hidden";
                this.visible = false;
            }

            toggleVisibility() {
                this.visible = !this.visible;
            }
        }

        customElements.define(GenesisPopover.is, GenesisPopover);
    </script>

</dom-module>
